//仿造大牛的做了个EMS验证码识别
//http://www.ems.com.cn/mailtracking/you_jian_cha_xun.html

function decaptcha(image){
    var letterArea = {
        '0': {'x1': 7, 'x2': 15, 'y1': 3, 'y2': 15},
        '1': {'x1': 20, 'x2': 28, 'y1': 3, 'y2': 15},
        '2': {'x1': 33, 'x2': 41, 'y1': 3, 'y2': 15},
        '3': {'x1': 46, 'x2': 54, 'y1': 3, 'y2': 15},
        '4': {'x1': 59, 'x2': 67, 'y1': 3, 'y2': 15},
        '5': {'x1': 72, 'x2': 80, 'y1': 3, 'y2': 15}
    };

    var captchaData = {
        '0': [
            [0, 0, 0, 1, 1, 1, 0, 0, 0],
            [0, 1, 1, 1, 1, 1, 1, 1, 0],
            [0, 1, 1, 0, 0, 0, 1, 1, 0],
            [1, 1, 0, 0, 0, 0, 0, 1, 1],
            [1, 1, 0, 0, 0, 0, 0, 1, 1],
            [1, 1, 0, 0, 0, 0, 0, 1, 1],
            [1, 1, 0, 0, 0, 0, 0, 1, 1],
            [1, 1, 0, 0, 0, 0, 0, 1, 1],
            [1, 1, 0, 0, 0, 0, 0, 1, 1],
            [1, 1, 0, 0, 0, 0, 0, 1, 1],
            [0, 1, 1, 0, 0, 0, 1, 1, 0],
            [0, 1, 1, 1, 1, 1, 1, 1, 0],
            [0, 0, 0, 1, 1, 1, 0, 0, 0]
        ],

        '1': [
            [0, 0, 1, 1, 1, 0, 0, 0, 2],
            [1, 1, 1, 1, 1, 0, 0, 0, 2],
            [1, 1, 1, 1, 1, 0, 0, 0, 2],
            [0, 0, 0, 1, 1, 0, 0, 0, 2],
            [0, 0, 0, 1, 1, 0, 0, 0, 2],
            [0, 0, 0, 1, 1, 0, 0, 0, 2],
            [0, 0, 0, 1, 1, 0, 0, 0, 2],
            [0, 0, 0, 1, 1, 0, 0, 0, 2],
            [0, 0, 0, 1, 1, 0, 0, 0, 2],
            [0, 0, 0, 1, 1, 0, 0, 0, 2],
            [0, 0, 0, 1, 1, 0, 0, 0, 2],
            [1, 1, 1, 1, 1, 1, 1, 1, 2],
            [1, 1, 1, 1, 1, 1, 1, 1, 2]
        ],

        '2': [
            [0, 1, 1, 1, 1, 1, 0, 0, 2],
            [1, 1, 1, 1, 1, 1, 1, 0, 2],
            [1, 0, 0, 0, 0, 0, 1, 1, 2],
            [0, 0, 0, 0, 0, 0, 1, 1, 2],
            [0, 0, 0, 0, 0, 0, 1, 1, 2],
            [0, 0, 0, 0, 0, 1, 1, 0, 2],
            [0, 0, 0, 0, 1, 1, 0, 0, 2],
            [0, 0, 0, 1, 1, 0, 0, 0, 2],
            [0, 0, 1, 1, 0, 0, 0, 0, 2],
            [0, 1, 1, 0, 0, 0, 0, 0, 2],
            [1, 1, 0, 0, 0, 0, 0, 0, 2],
            [1, 1, 1, 1, 1, 1, 1, 1, 2],
            [1, 1, 1, 1, 1, 1, 1, 1, 2]
        ],

        '3': [
            [0, 1, 1, 1, 1, 1, 0, 0, 2],
            [1, 1, 1, 1, 1, 1, 1, 1, 2],
            [1, 0, 0, 0, 0, 0, 1, 1, 2],
            [0, 0, 0, 0, 0, 0, 1, 1, 2],
            [0, 0, 0, 0, 0, 0, 1, 1, 2],
            [0, 1, 1, 1, 1, 1, 1, 0, 2],
            [0, 1, 1, 1, 1, 1, 1, 1, 2],
            [0, 0, 0, 0, 0, 1, 1, 1, 2],
            [0, 0, 0, 0, 0, 0, 1, 1, 2],
            [0, 0, 0, 0, 0, 0, 1, 1, 2],
            [1, 0, 0, 0, 0, 1, 1, 1, 2],
            [1, 1, 1, 1, 1, 1, 1, 0, 2],
            [0, 1, 1, 1, 1, 1, 0, 0, 2]
        ],

        '4': [
            [0, 0, 0, 0, 0, 1, 1, 0, 0],
            [0, 0, 0, 0, 1, 1, 1, 0, 0],
            [0, 0, 0, 0, 1, 1, 1, 0, 0],
            [0, 0, 0, 1, 1, 1, 1, 0, 0],
            [0, 0, 1, 1, 0, 1, 1, 0, 0],
            [0, 0, 1, 1, 0, 1, 1, 0, 0],
            [0, 1, 1, 0, 0, 1, 1, 0, 0],
            [0, 1, 1, 0, 0, 1, 1, 0, 0],
            [1, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 1],
            [0, 0, 0, 0, 0, 1, 1, 0, 0],
            [0, 0, 0, 0, 0, 1, 1, 0, 0],
            [0, 0, 0, 0, 0, 1, 1, 0, 0]
        ],

        '5': [
            [1, 1, 1, 1, 1, 1, 1, 1, 2],
            [1, 1, 1, 1, 1, 1, 1, 1, 2],
            [1, 1, 0, 0, 0, 0, 0, 0, 2],
            [1, 1, 0, 0, 0, 0, 0, 0, 2],
            [1, 1, 0, 0, 0, 0, 0, 0, 2],
            [1, 1, 1, 1, 1, 0, 0, 0, 2],
            [1, 1, 1, 1, 1, 1, 1, 0, 2],
            [0, 0, 0, 0, 0, 1, 1, 1, 2],
            [0, 0, 0, 0, 0, 0, 1, 1, 2],
            [0, 0, 0, 0, 0, 0, 1, 1, 2],
            [1, 0, 0, 0, 0, 1, 1, 1, 2],
            [1, 1, 1, 1, 1, 1, 1, 0, 2],
            [0, 1, 1, 1, 1, 1, 0, 0, 2]
        ],

        '6': [
            [0, 0, 0, 1, 1, 1, 1, 0, 0],
            [0, 0, 1, 1, 1, 1, 1, 1, 0],
            [0, 1, 1, 0, 0, 0, 0, 1, 0],
            [0, 1, 1, 0, 0, 0, 0, 0, 0],
            [1, 1, 0, 0, 0, 0, 0, 0, 0],
            [1, 1, 0, 1, 1, 1, 1, 0, 0],
            [1, 1, 1, 1, 1, 1, 1, 1, 0],
            [1, 1, 1, 0, 0, 0, 1, 1, 1],
            [1, 1, 0, 0, 0, 0, 0, 1, 1],
            [1, 1, 0, 0, 0, 0, 0, 1, 1],
            [0, 1, 1, 0, 0, 0, 1, 1, 1],
            [0, 1, 1, 1, 1, 1, 1, 1, 0],
            [0, 0, 0, 1, 1, 1, 1, 0, 0]
        ],

        '7': [
            [1, 1, 1, 1, 1, 1, 1, 1, 2],
            [1, 1, 1, 1, 1, 1, 1, 1, 2],
            [0, 0, 0, 0, 0, 0, 1, 1, 2],
            [0, 0, 0, 0, 0, 0, 1, 0, 2],
            [0, 0, 0, 0, 0, 1, 1, 0, 2],
            [0, 0, 0, 0, 1, 1, 0, 0, 2],
            [0, 0, 0, 0, 1, 0, 0, 0, 2],
            [0, 0, 0, 1, 1, 0, 0, 0, 2],
            [0, 0, 0, 1, 0, 0, 0, 0, 2],
            [0, 0, 1, 1, 0, 0, 0, 0, 2],
            [0, 0, 1, 1, 0, 0, 0, 0, 2],
            [0, 1, 1, 0, 0, 0, 0, 0, 2],
            [0, 1, 1, 0, 0, 0, 0, 0, 2]
        ],

        '8': [
            [0, 0, 1, 1, 1, 1, 1, 0, 0],
            [0, 1, 1, 1, 1, 1, 1, 1, 0],
            [0, 1, 1, 0, 0, 0, 1, 1, 0],
            [0, 1, 1, 0, 0, 0, 1, 1, 0],
            [0, 1, 1, 1, 0, 0, 1, 0, 0],
            [0, 0, 1, 1, 1, 1, 1, 0, 0],
            [0, 0, 1, 1, 1, 1, 1, 0, 0],
            [0, 1, 1, 0, 0, 1, 1, 1, 0],
            [1, 1, 0, 0, 0, 0, 0, 1, 1],
            [1, 1, 0, 0, 0, 0, 0, 1, 1],
            [1, 1, 1, 0, 0, 0, 1, 1, 1],
            [0, 1, 1, 1, 1, 1, 1, 1, 0],
            [0, 0, 1, 1, 1, 1, 1, 0, 0]
        ],

        '9': [
            [0, 0, 1, 1, 1, 1, 0, 0, 0],
            [0, 1, 1, 1, 1, 1, 1, 1, 0],
            [1, 1, 1, 0, 0, 0, 1, 1, 0],
            [1, 1, 0, 0, 0, 0, 0, 1, 1],
            [1, 1, 0, 0, 0, 0, 0, 1, 1],
            [1, 1, 1, 0, 0, 0, 1, 1, 1],
            [0, 1, 1, 1, 1, 1, 1, 1, 1],
            [0, 0, 1, 1, 1, 1, 0, 1, 1],
            [0, 0, 0, 0, 0, 0, 0, 1, 1],
            [0, 0, 0, 0, 0, 0, 1, 1, 0],
            [0, 1, 0, 0, 0, 0, 1, 1, 0],
            [0, 1, 1, 1, 1, 1, 1, 0, 0],
            [0, 0, 1, 1, 1, 1, 0, 0, 0]
        ]
    };

    var canvas = document.createElement("canvas").getContext('2d');
    canvas.drawImage(image, 0, 0);

    var isLetter = function(pixeldata) {
        var sum = pixeldata[0] + pixeldata[1] + pixeldata[2];
        if (sum < 150 * 3) {
            return 1;
        } else {
            return 0;
        }
    }

    var letter = [[], [], [], [], [], []];
    for(var id in letterArea) {
        var charWidth = letterArea[id].x2 - letterArea[id].x1;
        var charHeight = letterArea[id].y2 - letterArea[id].y1;
        var imageData = canvas.getImageData(letterArea[id].x1, letterArea[id].y1, charWidth, charHeight).data;


        for(var h = 0; h <= charHeight; h++) {
            letter[id][h] = [];
            for(var w = 0; w <= charWidth; w++) {
                var i = 4 * (w + h * charWidth);
                letter[id][h][w] = isLetter([].slice.call(imageData, i, i + 4));
            }
        }
    }

    var result = '';
    for(var i = 0; i < letter.length; i++){
        var maxError = 1000;
        var bestResult = ' ';
        for(var id in captchaData){
            var error = 0;
            for(var y = 0; y < letter[i].length; y++){
                for(var x = 0; x < letter[i][y].length; x++){
                    if(captchaData[id][y][x] != 2 && letter[i][y][x] != captchaData[id][y][x]){
                        error += 1;
                    }
                }
            }

            console.log("[" + i + ", " + id + "] " + error);

            if(error < maxError){
                maxError = error;
                bestResult = id;
            }
        }
        result += bestResult;
    }

    return result;
}

function main(target) {
    for(var id in target) {
        if(target[id]['img'] != undefined && target[id]['img'] != null && target[id]['input'] != undefined && target[id]['input'] != null) {
            target[id]['input'].value = decaptcha(target[id]['img']);
        }
    }
}

main([
    //速递查询
    {'img': document.getElementById("checkCode"), 'input':document.getElementsByName("checkCode")[0]}
]);
