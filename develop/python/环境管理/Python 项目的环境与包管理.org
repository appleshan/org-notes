#+TITLE: Python é¡¹ç›®çš„ç¯å¢ƒä¸åŒ…ç®¡ç†

@see https://zhuanlan.zhihu.com/p/32913361

* pipenv æ˜¯ä»€ä¹ˆï¼Ÿ
Pipenv æ˜¯ Python é¡¹ç›®çš„ç¯å¢ƒä¸åŒ…ç®¡ç†ã€‚

è¿™ä¸ªåº“ç›¸å½“äºæ˜¯ç¯å¢ƒç®¡ç†å’ŒåŒ…ç®¡ç†äºŒåˆä¸€ï¼Œç”± Kenneth Reitzï¼ˆRequests çš„ä½œè€… ï¼‰ç¼–å†™ï¼Œ
ç°åœ¨ç§»äº¤ç»™ Python å®˜æ–¹æ¥ç»´æŠ¤ï¼Œæä¾›æ¯” pip ä½“éªŒæ›´å¥½çš„å¼€å‘åŒ…ç®¡ç†ã€‚å®ƒçš„ Slogon æ˜¯
Python Development Workflow for Humansï¼Œç”¨æ¥è§£å†³å„ç§ç¯å¢ƒä¸ä¸€è‡´ã€å®‰è£…åŒ…çš„é—®é¢˜ã€‚

å…¶å®å®ƒä¸æ˜¯ä»€ä¹ˆå…ˆè¿›çš„ç†å¿µå’ŒæŠ€æœ¯ï¼Œå¦‚æœä½ ç†Ÿæ‚‰
Node.js çš„ npm/yarn æˆ– Ruby çš„ bundlerï¼Œé‚£ä¹ˆå°±éå¸¸å¥½ç†è§£äº†ï¼Œå®ƒåœ¨æ€è·¯ä¸Šä¸è¿™äº›å·¥å…·
ç±»ä¼¼ã€‚å°½ç®¡ pip å¯ä»¥å®‰è£… Python åŒ…ï¼Œä½†ä»æ¨èä½¿ç”¨ Pipenvï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ç§æ›´é«˜çº§çš„å·¥å…·ï¼Œ
å¯ç®€åŒ–ä¾èµ–å…³ç³»ç®¡ç†çš„å¸¸è§ä½¿ç”¨æƒ…å†µã€‚

ä¸»è¦ç‰¹æ€§åŒ…å«ï¼š

- æ ¹æ® Pipfile è‡ªåŠ¨å¯»æ‰¾é¡¹ç›®æ ¹ç›®å½•ã€‚
- å¦‚æœä¸å­˜åœ¨ï¼Œå¯ä»¥è‡ªåŠ¨ç”Ÿæˆ Pipfile å’Œ Pipfile.lockã€‚
- è‡ªåŠ¨åœ¨é¡¹ç›®ç›®å½•çš„ .venv ç›®å½•åˆ›å»ºè™šæ‹Ÿç¯å¢ƒã€‚
  ï¼ˆå½“ç„¶è¿™ä¸ªç›®å½•åœ°å€é€šè¿‡è®¾ç½® WORKON_HOME æ”¹å˜ï¼‰
- è‡ªåŠ¨ç®¡ç† Pipfile æ–°å®‰è£…å’Œåˆ é™¤çš„åŒ…ã€‚
- è‡ªåŠ¨æ›´æ–° pipã€‚

å¯¹äºæ–°æ‰‹å’Œè€æ‰‹æ¥è¯´éƒ½æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚

* pipenv éƒ½åŒ…å«ä»€ä¹ˆï¼Ÿ
pipenv æ˜¯ Pipfile ä¸»è¦å€¡å¯¼è€…ã€requests ä½œè€… Kenneth Reitz å†™çš„ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œä¸»
è¦åŒ…å«äº† Pipfileã€pipã€clickã€requests å’Œ virtualenvã€‚Pipfile å’Œ pipenv æœ¬æ¥éƒ½æ˜¯
Kenneth Reitz çš„ä¸ªäººé¡¹ç›®ï¼Œåæ¥è´¡çŒ®ç»™äº† pypa ç»„ç»‡ã€‚Pipfile æ˜¯ç¤¾åŒºæ‹Ÿå®šçš„ä¾èµ–ç®¡ç†æ–‡
ä»¶ï¼Œç”¨äºæ›¿ä»£è¿‡äºç®€é™‹çš„ requirements.txt æ–‡ä»¶ã€‚

Pipfile çš„åŸºæœ¬ç†å¿µæ˜¯ï¼š

- Pipfile æ–‡ä»¶æ˜¯ TOML æ ¼å¼è€Œä¸æ˜¯ requirements.txt è¿™æ ·çš„çº¯æ–‡æœ¬ã€‚
- ä¸€ä¸ªé¡¹ç›®å¯¹åº”ä¸€ä¸ª Pipfileï¼Œæ”¯æŒå¼€å‘ç¯å¢ƒä¸æ­£å¼ç¯å¢ƒåŒºåˆ†ã€‚
  é»˜è®¤æä¾› default å’Œ development åŒºåˆ†ã€‚æä¾›ç‰ˆæœ¬é”æ”¯æŒï¼Œå­˜ä¸º Pipfile.lockã€‚
- click æ˜¯ Flask ä½œè€… Armin Ronacher å†™çš„å‘½ä»¤è¡Œåº“ï¼Œç°åœ¨ Flask å·²ç»é›†æˆäº†å®ƒã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹çœ‹æ€ä¹ˆä½¿ç”¨å®ƒå§

* å…¥é—¨
pipenv å…¼å®¹ Python 2/3ï¼Œæˆ‘ä»¬è¿™é‡Œä»¥ Mac ä¸‹ Python 3 ä¸ºä¾‹ï¼š

** å®‰è£… pipenv
#+BEGIN_SRC sh
â¯ brew install python3  # å¦‚æœå·²ç»å®‰è£…äº†å¯ä»¥å¿½ç•¥
â¯ python3 -m pip install --upgrade --force-reinstall pip
â¯ pip3 install pipenv --user  # æ¨èå®‰è£…åœ¨ä¸ªäººç›®å½•ä¸‹
â¯ export PATH="/Users/dongweiming/Library/Python/3.6/bin:$PATH"  # æŠŠç”¨æˆ·ç›®å½•ä¸‹ bin æ”¾åœ¨æœ€å‰é¢ï¼Œè¿™æ ·å¯ä»¥ç›´æ¥ä½¿ç”¨ pipenv äº†
#+END_SRC

** ä½¿ç”¨ pipenv
ç”¨ä¸€ä¸ªç©ºç›®å½•ä½“éªŒä¸€ä¸‹ï¼š
#+BEGIN_EXAMPLE
â¯ mkdir test_pipenv
â¯ cd test_pipenv
â¯ pipenv install  # åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿç¯å¢ƒ
Creating a virtualenv for this projectâ€¦
...
Installing setuptools, pip, wheel...done.
Virtualenv location: /Users/dongweiming/.virtualenvs/test_pipenv-GP_s2TW5
Creating a Pipfile for this projectâ€¦
Pipfile.lock not found, creatingâ€¦
Locking [dev-packages] dependenciesâ€¦
Locking [packages] dependenciesâ€¦
Updated Pipfile.lock (c23e27)!
Installing dependencies from Pipfile.lock (c23e27)â€¦
  ğŸ   â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰ 0/0 â€” 00:00:00
To activate this project's virtualenv, run the following:
 $ pipenv shell
â¯ which python3
/usr/local/Cellar/python3/3.6.1/bin/python3  # è¿˜æ˜¯ mac è‡ªå¸¦çš„ Python
â¯ pipenv shell  # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
Spawning environment shell (/bin/zsh). Use 'exit' to leave.
source /Users/dongweiming/.virtualenvs/test_pipenv-GP_s2TW5/bin/activate
â¯ which python3  # å·²ç»åœ¨è™šæ‹Ÿç¯å¢ƒé‡Œäº†
/Users/dongweiming/.virtualenvs/test_pipenv-GP_s2TW5/bin/python3
â¯ exit  # é€€å‡ºè™šæ‹Ÿç¯å¢ƒ
â¯ which python3
/usr/local/Cellar/python3/3.6.1/bin/python3
#+END_EXAMPLE
ä»¥ä¸Šå°±æ˜¯åŸæ¥ virtualenv çš„åŸºæœ¬ç”¨æ³•äº†ã€‚

æˆ‘ä»¬çœ‹ä¸€ä¸‹å½“å‰ç›®å½•ç°åœ¨æ˜¯ä»€ä¹ˆæ ·å­çš„:
#+BEGIN_EXAMPLE
â¯ ls
Pipfile  Pipfile.lock
#+END_EXAMPLE

è¿™ä¸ªç¯å¢ƒä¸‹ç›®å‰ä»€ä¹ˆéƒ½æ²¡æœ‰ã€‚æˆ‘ä»¬å®‰è£… 2 ä¸ªåŒ…ï¼š
#+BEGIN_EXAMPLE
â¯ pipenv install elasticsearch-dsl requests
Installing elasticsearch-dslâ€¦
...
Adding elasticsearch-dsl to Pipfile's [packages]â€¦
Installing requestsâ€¦
...
Adding requests to Pipfile's [packages]â€¦
  PS: You have excellent taste! âœ¨ ğŸ° âœ¨
Locking [dev-packages] dependenciesâ€¦
Locking [packages] dependenciesâ€¦
Updated Pipfile.lock (8d307d)!
#+END_EXAMPLE

ç°åœ¨ Pipfile.lock å·²ç»æ›´æ–°äº†ï¼ŒåŒ…å«äº† elasticsearch-dslã€requests å’Œç›¸å…³ä¾èµ–çš„åŒ…
ä¿¡æ¯ã€‚

å¦å¤–å¦‚æœä½ æ·»åŠ --two æˆ–--three æ ‡å¿—åˆ°ä¸Šé¢çš„æœ€åä¸€ä¸ªå‘½ä»¤ï¼Œå®ƒåˆ†åˆ«ä½¿ç”¨ Python 2 æˆ– 3
æ¥åˆå§‹åŒ–ä½ çš„é¡¹ç›®ã€‚ å¦åˆ™å°†ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬çš„ Pythonã€‚

å¯ä»¥çœ‹ä¸€ä¸‹ä¾èµ–å…³ç³»ï¼š
#+BEGIN_EXAMPLE
â¯ pipenv graph
elasticsearch-dsl==6.1.0
  - elasticsearch [required: <7.0.0,>=6.0.0, installed: 6.1.1]
    - urllib3 [required: <1.23,>=1.21.1, installed: 1.22]
  - ipaddress [required: Any, installed: 1.0.19]
  - python-dateutil [required: Any, installed: 2.6.1]
    - six [required: >=1.5, installed: 1.10.0]
  - six [required: Any, installed: 1.10.0]
requests==2.18.4
  - certifi [required: >=2017.4.17, installed: 2017.11.5]
  - chardet [required: <3.1.0,>=3.0.2, installed: 3.0.4]
  - idna [required: <2.7,>=2.5, installed: 2.6]
  - urllib3 [required: <1.23,>=1.21.1, installed: 1.22]
#+END_EXAMPLE

å¯ä»¥çœ‹åˆ°ï¼Œä»–ä¿©éƒ½ä¾èµ–äº† urllib3ã€‚è™½ç„¶ç°åœ¨ pipenv ä¸èƒ½ç›´æ¥å¸è½½åŒ…åŠå…¶ä¾èµ–ï¼Œä½†æ˜¯ç”±äº
å®ƒæä¾›äº†è‰¯å¥½çš„æ¥å£ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¯ä»¥å®ç°ï¼š
#+BEGIN_EXAMPLE
â¯ pipenv uninstall `pipenv graph --json |python3 depends.py requests`
Un-installing certifiâ€¦
Uninstalling certifi-2017.11.5:
  Successfully uninstalled certifi-2017.11.5
No package certifi to remove from Pipfile.
Un-installing requestsâ€¦
Uninstalling requests-2.18.4:
  Successfully uninstalled requests-2.18.4
Removing requests from Pipfileâ€¦
Un-installing idnaâ€¦
Uninstalling idna-2.6:
  Successfully uninstalled idna-2.6
No package idna to remove from Pipfile.
Un-installing chardetâ€¦
Uninstalling chardet-3.0.4:
  Successfully uninstalled chardet-3.0.4
No package chardet to remove from Pipfile.
Locking [dev-packages] dependenciesâ€¦
Locking [packages] dependenciesâ€¦
Updated Pipfile.lock (c05ac4)!
#+END_EXAMPLE

å…¶ä¸­ depends.py è„šæœ¬ä¼šè§£æä¾èµ–å…³ç³»ï¼Œæ’é™¤å…¶ä»–åŒ…ä¾èµ–çš„é¡¹ç›®ç„¶ååˆ é™¤ï¼š
#+BEGIN_SRC sh
â¯ cat depends.py
#+END_SRC
#+BEGIN_SRC python
import sys
import json
package = sys.argv[1]
other_dependencies = set()
removing_dependencies = set([package])
for i in json.load(sys.stdin):
    for p in i['dependencies']:
        key = p['key']
        if i['package']['key'] == package:
            removing_dependencies.add(key)
        else:
            other_dependencies.add(key)
print(' '.join(removing_dependencies - other_dependencies))
#+END_SRC

å†çœ‹ä¸€ä¸‹ç°åœ¨ç¯å¢ƒä¸­çš„åŒ…ä¾èµ–å…³ç³»ï¼š
#+BEGIN_EXAMPLE
â¯ pipenv graph
elasticsearch-dsl==6.1.0
  - elasticsearch [required: >=6.0.0,<7.0.0, installed: 6.1.1]
    - urllib3 [required: >=1.21.1,<1.23, installed: 1.22]
  - ipaddress [required: Any, installed: 1.0.19]
  - python-dateutil [required: Any, installed: 2.6.1]
    - six [required: >=1.5, installed: 1.10.0]
  - six [required: Any, installed: 1.10.0]
#+END_EXAMPLE
æ˜¯ä¸æ˜¯å¾ˆå¹²å‡€å‘¢ï¼Ÿ

* å…¶ä»–åŠŸèƒ½
é™¤äº†ä¸Šè¿°åŸºæœ¬åŠŸèƒ½ä»¥å¤–ï¼Œpipenv è¿˜æœ‰å¾ˆå¤šé™„åŠ çš„åŠŸèƒ½ï¼Œæˆ‘ä¸¾å‡ ä¸ªæ—¥å¸¸æ¯”è¾ƒå¸¸ç”¨çš„ä¾‹å­ï¼š
#+BEGIN_EXAMPLE
â¯ pipenv run which python # ã€Œpipenv runã€å¯ä»¥æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼Œå¹¶ä½¿ç”¨ shell å‘½ä»¤
/Users/dongweiming/.virtualenvs/test_pipenv-GP_s2TW5/bin/python
â¯ pipenv check  # æ£€æŸ¥è£…çš„åŒ…çš„å®‰å…¨æ€§
Checking PEP 508 requirementsâ€¦
Passed!
Checking installed package safetyâ€¦
All good!
â¯ pipenv --man  # ä¼ ç»Ÿçš„çœ‹æ–‡æ¡£çš„æ–¹æ³•
â¯ pipenv check --style depends.py  # ä»£ç  Flake8 æ£€æŸ¥ï¼Œåœ¨è¿™é‡Œæˆ‘ä¿®æ”¹äº† depends.py è®©å®ƒæ•…æ„æœ‰é—®é¢˜
/Users/dongweiming/test_pipenv/depends.py:1:1: F401 'os' imported but unused
#+END_EXAMPLE

å¦å¤–ç”±äº autoenv ä¹Ÿæ˜¯ Kenneth Reitz å†™çš„ï¼Œæ‰€ä»¥ pipenv é»˜è®¤ä¹ŸåŒ…å«äº†å¯¹.env æ–‡ä»¶çš„
æ”¯æŒã€‚

æ˜¯ä¸æ˜¯æ–¹ä¾¿å¾ˆå¤šå‘¢ï¼Ÿ
