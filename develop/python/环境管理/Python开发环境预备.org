#+TITLE: Python å¼€å‘ç¯å¢ƒé¢„å¤‡

* ä»¥ pyenv åŠ pipenv + autoenv çš„æ–¹å¼å¼€å‘ Python
æ‰€æ¶‰åŠåˆ°çš„å·¥å…·æœ‰ï¼š

- pyenv : ç‰ˆæœ¬ç®¡ç†
- pipenv : å¼€å‘å·¥ä½œæµç®¡ç†
- autoenv : åŸºäºç›®å½•çš„ç¯å¢ƒè‡ªåŠ¨æ„å»º

* Python ç‰ˆæœ¬ç®¡ç† - pyenv
Pyenv æ˜¯ä¸€ç§å¯ä»¥å®ç°å®‰è£…ä¸åŒç‰ˆæœ¬ Python å¹¶å¯åœ¨ä¸åŒç‰ˆæœ¬é—´ä»»æ„åˆ‡æ¢çš„ç®¡ç†å·¥å…·ã€‚

* Python é¡¹ç›®çš„ç¯å¢ƒåŠåŒ…ç®¡ç† - pipenv
Pipenv æ˜¯ python é¡¹ç›®ä¸­çš„åŒ…ç®¡ç†å·¥å…·ï¼Œé€šè¿‡ pipenv å®‰è£…çš„ pyhon åŒ…å°†è¢«è®°å½•äº
pipfile å½“ä¸­ï¼Œæ–¹ä¾¿é¡¹ç›®ä¸­åŒ…çš„ä¾èµ–ç®¡ç†åŠå®‰è£…éƒ¨ç½²;
Pipenv å·¥å…·æ˜¯é›† pip, pipfile, virtualenv äºä¸€èº«ï¼Œæ•…å®ƒä¹Ÿå®ç°äº†é¡¹ç›®ç›®å½•çš„è™šæ‹Ÿç¯å¢ƒ
åˆ›å»ºï¼Œä½¿å¾—å…¶é¡¹ç›®çš„è¿è¡Œç¯å¢ƒèƒ½å¤Ÿæ»¡è¶³ç‹¬ç«‹ä¸”éš”ç¦»ï¼Œä¸å—ç³»ç»ŸåŠå…¶ä»–ç¯å¢ƒçš„å½±å“;

** pipenv çš„ä½¿ç”¨
å‰æï¼šå‡è®¾æˆ‘ä»¬åœ¨ç”¨æˆ·ç›®å½• ~ ä¸‹æœ‰ä¸€ä¸ªé¡¹ç›®å« my_projectã€‚

æˆ‘ä»¬é¦–å…ˆè¿›å…¥é¡¹ç›®ç›®å½•ï¼š
#+BEGIN_EXAMPLE
$ cd ~/my_project
#+END_EXAMPLE

è¿›å…¥é¡¹ç›®ä»¥åï¼Œå¦‚æœç›´æ¥æ‰§è¡Œ pipenv installï¼Œpipenv ä¼šæ ¹æ®ç³»ç»Ÿé»˜è®¤çš„ python ç‰ˆæœ¬ï¼Œ
æ¥åˆ›å»ºè™šæ‹Ÿç¯å¢ƒã€‚å‰ææ˜¯æœ¬é¡¹ç›®ä¸­ä¸å­˜åœ¨å·²æœ‰çš„ Pipfileï¼Œå¦‚æœæœ‰ï¼Œå®ƒä¼šå»æ ¹æ® Pipfile
å®‰è£…å¯¹åº”çš„ç‰ˆæœ¬å’Œ Pipfile ä¸­è®°å½•çš„ä¾èµ–åº“ã€‚

ä½†æ˜¯æˆ‘ä»¬ä¸€èˆ¬ä¼šåˆ›å»ºè™šæ‹Ÿç¯å¢ƒçš„æ—¶å€™æŒ‡å®š python ç‰ˆæœ¬,å°±éœ€è¦é…ä¸Š --two æˆ–è€…--three è¿™
ä¸ªå‚æ•°:

- --two ä½¿ç”¨ python2 æ¥åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼Œéœ€è¦ç¡®ä¿ç³»ç»Ÿä¸­å­˜åœ¨ python2 ç‰ˆæœ¬
- --three ä½¿ç”¨ python3 æ¥åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼Œéœ€è¦ç¡®ä¿ç³»ç»Ÿä¸­å­˜åœ¨ python3 ç‰ˆæœ¬

#+BEGIN_EXAMPLE
$ pipenv install --three
#+END_EXAMPLE

ä¸‹é¢æ˜¯æ‰§è¡Œåçš„è¾“å‡ºä¿¡æ¯ï¼š

#+BEGIN_EXAMPLE
Creating a virtualenv for this projectâ€¦
Using /usr/local/bin/python3 to create virtualenvâ€¦

# è¿™é‡Œå¯ä»¥çœ‹åˆ°ç»§æ‰¿è‡ªå“ªä¸ª python ç‰ˆæœ¬
â ‹Running virtualenv with interpreter /usr/local/bin/python3 Using base prefix '/usr/local'
New python executable in /root/.local/share/virtualenvs/my_project-dhpIKgdN/bin/python3
Also creating executable in /root/.local/share/virtualenvs/my_project-dhpIKgdN/bin/python
Installing setuptools, pip, wheel...done.

# è¿™é‡Œå¯ä»¥çœ‹åˆ°è™šæ‹Ÿç¯å¢ƒå®‰è£…çš„ä½ç½®
Virtualenv location: /root/.local/share/virtualenvs/my_project-dhpIKgdN
Creating a Pipfile for this projectâ€¦
Pipfile.lock not found, creatingâ€¦
Locking [dev-packages] dependenciesâ€¦
Locking [packages] dependenciesâ€¦
Updated Pipfile.lock (625834)!
Installing dependencies from Pipfile.lock (625834)â€¦
  ğŸ   â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰ 0/0 â€” 00:00:00
To activate this project's virtualenv, run the following:
 $ pipenv shell # è¦æ¿€æ´»è¯¥è™šæ‹Ÿç¯å¢ƒï¼Œæ‰§è¡Œè¿™æ¡æŒ‡ä»¤
#+END_EXAMPLE

è¿™å°†åœ¨é¡¹ç›®ç›®å½•ä¸­åˆ›å»ºä¸¤ä¸ªæ–°æ–‡ä»¶ Pipfile å’Œ Pipfile.lockï¼š

- Pipfile å­˜æ”¾ç€å½“å‰è™šæ‹Ÿç¯å¢ƒçš„é…ç½®ä¿¡æ¯ã€‚
  åŒ…å« python ç‰ˆæœ¬ï¼Œpypi æºï¼Œä»¥åŠé¡¹ç›®å®‰è£…çš„ä¾èµ–åº“ã€‚
  pipenv æ ¹æ®è¿™ä¸ªæ¥å¯»æ‰¾é¡¹ç›®çš„æ ¹ç›®å½•ã€‚
  Pipfile æ–‡ä»¶æ˜¯ TOML æ ¼å¼è€Œä¸æ˜¯ requirements.txt é‚£æ ·çš„çº¯æ–‡æœ¬ã€‚
  ä¸€ä¸ªé¡¹ç›®å¯¹åº”ä¸€ä¸ª Pipfileï¼Œæ”¯æŒå¼€å‘ç¯å¢ƒä¸æ­£å¼ç¯å¢ƒåŒºåˆ†ã€‚é»˜è®¤æä¾› default å’Œ
  development åŒºåˆ†ã€‚
- Pipfile.lock é¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªæ–‡ä»¶æ—¶å¯¹äº Pipfile çš„ä¸€ä¸ªé”å®šã€‚
  æ”¯æŒé”å®šé¡¹ç›®ä¸åŒçš„ç‰ˆæœ¬æ‰€ä¾èµ–çš„ç¯å¢ƒã€‚

æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ, åœ¨å½“å‰ç›®å½•æ‰§è¡Œä¸‹é¢çš„æŒ‡ä»¤å³å¯ï¼š

#+BEGIN_EXAMPLE
$ pipenv shell
#+END_EXAMPLE

** æ›´æ–° pypi æºæ¥æé«˜ä¾èµ–åº“å®‰è£…çš„é€Ÿåº¦
åœ¨ä½¿ç”¨ pipenv çš„æ—¶å€™ï¼Œå¸¸å¸¸ä¼šåœ¨å®‰è£…çš„æ—¶å€™ï¼Œä¸€ç›´å¡åœ¨äº† Locking è¿™é‡Œï¼Œé€šè¿‡åŠ ä¸Š -v
å‚æ•°ï¼Œå¯ä»¥çœ‹åˆ°å®‰è£…è¿‡ç¨‹ä¸­çš„æ­¥éª¤ä¿¡æ¯ï¼Œå¡åœ¨äº†ä¸‹è½½é‚£é‡Œï¼Œè¿™æ—¶åº”è¯¥å¯ä»¥æ„è¯†åˆ°æ˜¯å› ä¸ºç½‘ç»œ
çš„åŸå› ï¼Œpipenv åˆ›å»ºçš„ Pipfile ä¸­é»˜è®¤çš„ pypi æºæ˜¯ python å®˜æ–¹çš„
[https://pypi.python.org/simple]ã€‚æˆ‘ä»¬å›½å†…ç”¨æˆ·è®¿é—®ä¸‹è½½çš„æ—¶å€™ä¼šå¾ˆæ…¢ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä¸€èˆ¬ä¼šåœ¨åˆ›å»ºå¥½ Pipfile ä»¥åï¼Œä¿®æ”¹åˆ°æ–‡ä»¶ä¸­ source å—ä¸‹çš„ url å­—æ®µï¼Œè®¾ç½®ä¸º
å›½å†…çš„ pypi æºå°±å¥½äº†ï¼Œæˆ‘æ¨èçš„æ˜¯æ¸…åçš„ pypi æºï¼Œå…·ä½“è®¾ç½®å¦‚ä¸‹ï¼š

#+BEGIN_EXAMPLE
[[source]]
url = "https://pypi.tuna.tsinghua.edu.cn/simple"
verify_ssl = true
name = "pypi"
#+END_EXAMPLE

å¤‡æ³¨ï¼šæˆ‘è¿˜æ²¡æœ‰æ‰¾åˆ°å¦‚ä½•ä¿®æ”¹èƒ½åœ¨åˆ›å»ºæ—¶å°±è®¾å¥½çš„æ–¹æ³•ï¼Œåº”è¯¥ä¿®æ”¹æºç æ˜¯å¯ä»¥çš„ï¼Œä½†è¿™æ ·ä¸
å°Šé‡æºç ï¼Œæ¯•ç«Ÿé«˜å¢™æ˜¯æˆ‘ä»¬è‡ªå·±ç­‘èµ·çš„ï¼Œå¦‚æœæœ‰å¥½çš„æ–¹æ³•ï¼Œæ‚¨ä¸å¦¨åœ¨è¯„è®ºä¸­å‘Šè¯‰æˆ‘ä¸€ä¸‹ã€‚

** ç®¡ç† Python ä¾èµ–å…³ç³»
Pipfile åŒ…å«å…³äºé¡¹ç›®çš„ä¾èµ–åŒ…çš„ä¿¡æ¯ï¼Œå¹¶å–ä»£é€šå¸¸åœ¨ Python é¡¹ç›®ä¸­ä½¿ç”¨çš„
requirements.txt æ–‡ä»¶ã€‚ å¦‚æœä½ ä¹‹å‰çš„é¡¹ç›®ä¸­å­˜åœ¨ requirements.txt æ–‡ä»¶ï¼Œpipenv å¯
ä»¥å¾ˆè½»æ¾çš„å®‰è£… requirements.txt ä¸­çš„ä¾èµ–åŒ…ã€‚

#+BEGIN_EXAMPLE
pipenv install -r requirements.txt
# æˆ–è€…
pipenv install --requirements requirements.txt
#+END_EXAMPLE

å¯ä»¥é€šè¿‡æ›´æ–° Pipfile.lock æ¥å†»ç»“è½¯ä»¶åŒ…åç§°åŠå…¶ç‰ˆæœ¬ä»¥åŠå…¶è‡ªå·±çš„ä¾èµ–å…³ç³»çš„åˆ—è¡¨ã€‚è¿™
æ—¶éœ€è¦ä½¿ç”¨ lock å…³é”®å­—æ¥å®Œæˆï¼Œ

#+BEGIN_EXAMPLE
$ pipenv lock
#+END_EXAMPLE

å¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨è™šæ‹Ÿç¯å¢ƒä¸­å®‰è£…æŸä¸ªæŒ‡å®šçš„åº“ï¼Œæ¯”å¦‚ requests, ç›´æ¥åœ¨ install åé¢è·Ÿä¸Š
å°±å¯ä»¥äº†:

#+BEGIN_EXAMPLE
$ pipenv install requests
#+END_EXAMPLE

å¦‚æœæƒ³æŸ¥çœ‹å½“å‰ç¯å¢ƒä¸­ç¬¬ä¸‰æ–¹åŒ…ä¹‹é—´çš„ä¾èµ–å…³ç³»,å¯ä»¥é€šè¿‡ pipenv graph æ¥æŸ¥çœ‹ï¼š

#+BEGIN_EXAMPLE
[root@VM_27_243_centos my_project]# pipenv graph
requests==2.18.4
  - certifi [required: >=2017.4.17, installed: 2018.1.18]
  - chardet [required: <3.1.0,>=3.0.2, installed: 3.0.4]
  - idna [required: <2.7,>=2.5, installed: 2.6]
  - urllib3 [required: <1.23,>=1.21.1, installed: 1.22]
#+END_EXAMPLE

ä»è¾“å‡ºå¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬æŒ‰ç…§çš„ requests åŒ…ï¼Œä¾èµ–äºå…¶ä»–çš„å››ä¸ªåŒ…ï¼Œpipenv å¸®ä½ è‡ªåŠ¨ç®¡ç†
ç€è¿™äº›åŒ…è¿™ä»¶çš„ä¾èµ–å…³ç³»ã€ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ° requests ä¾èµ–äº urllib3ï¼Œ å‡è®¾æˆ‘ä»¬å†å®‰è£…
ä¸€ä¸ªåŒ…ï¼Œå¹¶ä¸”è¿™ä¸ªåŒ…ä¹ŸåŒæ ·ä¾èµ–ç€ urllib3 ,å½“æˆ‘ä»¬è¦å¸è½½æ‰ requests çš„æ—¶å€™ï¼Œpipenv
ä¼šè‡ªåŠ¨æ£€æµ‹è¿™äº›åŒ…ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå› ä¸º urllib3 ä¾æ—§æœ‰å…¶ä»–åŒ…ä¾èµ–ï¼Œæ‰€ä»¥ä¼šä¿ç•™ï¼Œåªä¼š
å¸è½½æ‰å…¶ä»–çš„ä¾èµ–åº“ã€‚
å¸è½½çš„æŒ‡ä»¤æ˜¯ pipenv uninstallã€‚

** é€€å‡ºè™šæ‹Ÿç¯å¢ƒ
ä»»ä½•æ—¶å€™æƒ³é€€å‡ºè™šæ‹Ÿç¯å¢ƒï¼Œåªéœ€ä¸€æ¡ç®€å•çš„ exit æŒ‡ä»¤å³å¯
#+BEGIN_EXAMPLE
$ exit
#+END_EXAMPLE

** ä½¿ç”¨ä½“éªŒ
è¿‘æœŸçš„é¡¹ç›®ä¸­ï¼Œæˆ‘å¼€å§‹å°è¯•ç€ä» virtualenv ç®¡ç† python è™šæ‹Ÿç¯å¢ƒï¼Œåˆ‡æ¢åˆ°ç”¨ pipenv æ¥
ç®¡ç†ã€‚ç»è¿‡ä¸€æ®µæ—¶é—´çš„ä½¿ç”¨ï¼Œç€å®è§‰å¾— pipenv ä½¿ç”¨çš„æ›´åŠ é¡ºæ‰‹ï¼Œæ›´åŠ çš„ä¾¿æ·ã€‚è¿™å½“ç„¶ä¹Ÿå»¶
ç»­äº† Kenneth å¤§ç¥ä¸€è´¯çš„é¡¹ç›®ä½œé£-- For Humansã€‚å†é…åˆä¸Š autoenvï¼Œæ›´åŠ çš„å®Œå–„ï¼

* Python é¡¹ç›®ç¯å¢ƒçš„è‡ªå¯åŠ¨ - autoenv
autoenv å¯ä»¥å®ç°åœ¨è¿›å…¥é¡¹ç›®ç›®å½•æ—¶ï¼Œå°†è‡ªå¯åŠ¨éœ€è¦çš„è¿è¡Œç¯å¢ƒ;

1 . å®‰è£… autoenv
ä½¿ç”¨ pip æ–¹å¼å®‰è£…å­˜åœ¨é—®é¢˜ï¼Œä¼šå¯¼è‡´ terminal å¼‚å¸¸é€€å‡ºï¼Œä¹‹åçš„ç‰ˆæœ¬å¯èƒ½ä¼šæœ‰æ›´æ–°;
ç›®å‰æ˜¯ä»¥ git æ–¹å¼è¿›è¡Œå®‰è£…ï¼š
#+BEGIN_EXAMPLE
$ git clone git://github.com/kennethreitz/autoenv.git ~/.autoenv
$ echo 'source ~/.autoenv/activate.sh' >> ~/.bashrc
#+END_EXAMPLE

2 . åˆ›å»º.env æ–‡ä»¶
åœ¨å·²æœ‰çš„ pipenv é¡¹ç›®ä¸­è¿è¡Œ pipenv shell,
ä¼šå¾—åˆ°è™šæ‹Ÿç¯å¢ƒè·¯å¾„ä¿¡æ¯ï¼Œé€šè¿‡ä¿¡æ¯åˆ›å»º.env è¿è¡Œç¯å¢ƒæ–‡ä»¶;
#+BEGIN_EXAMPLE
$ echo "source /home/{userName}/.local/share/virtualenvs/{projectName}/bin/activate" > {projectName}/.env
#+END_EXAMPLE

3 . å†æ¬¡è¿›å…¥é¡¹ç›®ç›®å½•ï¼Œå°†è‡ªå¯åŠ¨è¯¥é¡¹ç›®çš„è™šæ‹Ÿç¯å¢ƒ

æ›´å¥½çš„ä½¿ç”¨æ–¹æ³•å‚è€ƒæœ¬ç¬”è®° repo ä¸­çš„ã€Š[[./python çš„ autoenv ä½¿ç”¨ç®€æ˜æ‰‹å†Œ.org][python çš„ autoenv ä½¿ç”¨ç®€æ˜æ‰‹å†Œ]]ã€‹ã€‚

* å‚è€ƒèµ„æ–™
- https://jiangink.github.io/2018/01/28/PythonEnv/
- https://vimiix.com/post/2018/03/11/manage-your-virtualenv-with-pipenv/
